<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FITCODE</title>
    <link rel="icon" href="/logo_color.ico" type="image/x-icon">
    <link rel="stylesheet" href="./src/styles/style.css" />
    <link rel="stylesheet" href="./src/styles/loginStyle.css" />
    <link rel="stylesheet" href="./src/styles/user.css" />
    <link rel="stylesheet" href="./src/styles/cardInfoStyle.css" />
    <link rel="stylesheet" href="./src/styles/cardActivity.css" />
    <link rel="stylesheet" href="./src/styles/cardQuickAction.css" />
    <link rel="stylesheet" href="./src/styles/cardNextSession.css" />
    <link rel="stylesheet" href="./src/styles/cardPlan.css" />
    <link rel="stylesheet" href="./src/styles/cardAssignment.css" />
    <link rel="stylesheet" href="./src/styles/plan.css" />
    <link rel="stylesheet" href="./src/styles/planCreate.css" />
    <link rel="stylesheet" href="./src/styles/assignment.css" />
    <link rel="stylesheet" href="./src/styles/modalPlanDetail.css" />

    <link rel="stylesheet" href="./src/styles/modalAssignmentNew.css" />
    <link rel="stylesheet" href="./src/styles/modalStatics.css" />
    <link rel="stylesheet" href="./src/styles/statistics.css" />
    <link rel="stylesheet" href="./src/styles/comboBox.css" />
    <link rel="stylesheet" href="./src/styles/switch.css" />
    <link rel="stylesheet" href="./src/styles/datePicker.css" />
    <link rel="stylesheet" href="./fonts/Material-Symbols-Outlined.woff2" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Ubuntu:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&display=swap" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>


    <style>

    </style>

</head>


<body>
    <div id="fitcode1">
        <button onclick="openStatisticsModal()">Ver Detalle del Plan</button>

        <div class="plan-new-header flex gap-4 items-center">
            <div class="flex-none">
                <div class="button-small"><span class="material-symbols-outlined">keyboard_arrow_left</span></div>
            </div>
            <div class="w-64 flex-auto">
                <div class="flex flex-col flex-auto w-full">
                    <div>
                        <h1>Crear Plan de Entrenamiento</h1>
                    </div>
                </div>
            </div>
            <div>
                <div class="flex flex-row gap-4 items-center">
                    <button class="button-small-cancel">Cancelar</button>
                    <button class="button-small"><span class="material-symbols-outlined">save</span>Guardar
                        Plan</button>
                </div>
            </div>
        </div>
        <div class="flex flex-row w-full">
            <div class="plan-new-main">
                <div class="plan-new-preview p-6 space-y-6">
                    <div class="">
                        <h2><span class="material-symbols-outlined">article</span> Vista Previa del Plan</h2>
                        <div class="general-info">
                            <div class="flex flex-col space-y-1.5 p-6 pb-3">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1">
                                        <h3 class="name" id="plan-preview-name">Nombre del plan</h3>
                                        <p class="description" id="plan-preview-description"> Descripción del plan...
                                        </p>
                                    </div>
                                    <div class="type">Plantilla</div>
                                </div>
                            </div>
                            <div class="p-6 pt-0 space-y-4">
                                <div class="grid grid-cols-3 gap-3">
                                    <div class="objective flex items-center gap-2">
                                        <span class="objective-icon material-symbols-outlined">target</span>
                                        <div>
                                            <p class="objective-title">Objetivo</p>
                                            <p class="objective-text">Fuerza</p>
                                        </div>
                                    </div>

                                    <div class="session flex items-center gap-2">
                                        <span class="session-icon material-symbols-outlined">format_list_bulleted</span>
                                        <div>
                                            <p class="session-title">Sesiones</p>
                                            <p class="session-text">3</p>
                                        </div>
                                    </div>

                                    <div class="excercise flex items-center gap-2">
                                        <span class="excercise-icon material-symbols-outlined">exercise</span>
                                        <div>
                                            <p class="excercise-title">Ejercicios</p>
                                            <p class="excercise-text">10</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="session-detail pt-6 space-y-3">
                            <h3 class="title" id="plan-session-preview-amount">Sesiones (0)</h3>
                            <div id="session-cards-container" class="space-y-4 mt-4"></div>
                        </div>
                    </div>
                </div>
                <div class="plan-new-create p-6 space-y-6">
                    <div class="plan-new-create-template">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="flex items-center gap-2"><span
                                    class="material-symbols-outlined">content_copy</span>Cargar desde plantilla</h3>
                        </div>
                        <div class="p-6 pt-0">

                            <button type="button" role="combobox" aria-controls="radix-:ra:" aria-expanded="false"
                                aria-autocomplete="none" dir="ltr" data-state="closed"
                                class="flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&amp;&gt;span]:line-clamp-1"><span
                                    style="pointer-events: none;">Fuerza Avanzada</span><svg
                                    xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" class="lucide lucide-chevron-down h-4 w-4 opacity-50"
                                    aria-hidden="true">
                                    <path d="m6 9 6 6 6-6"></path>
                                </svg></button>
                        </div>
                    </div>
                    <div class="plan-new-create-general">
                        <div class="flex flex-row justify-between items-center space-y-1.5 p-6">
                            <h3 class="flex items-center gap-2">Información General</h3>
                            <div class="flex items-center space-x-2"><button type="button" role="switch"
                                    aria-checked="true" data-state="checked" value="on"
                                    class="peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors data-[state=checked]:bg-primary data-[state=unchecked]:bg-input focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50"
                                    id="esPlantilla"><span data-state="checked"
                                        class="pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0"></span></button><input
                                    type="checkbox" aria-hidden="true" tabindex="-1" value="on" checked=""
                                    style="transform: translateX(-100%); position: absolute; pointer-events: none; opacity: 0; margin: 0px; width: 44px; height: 24px;"><label
                                    class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70 cursor-pointer"
                                    for="esPlantilla">Guardar como plantilla</label></div>
                        </div>
                        <div class="p-6 pt-0 space-y-4">
                            <div class="space-y-2">
                                <label>Nombre del Plan *</label>
                                <input class="input" id="plan-name" placeholder="Ej: Fuerza Avanzada">
                            </div>
                            <div class="space-y-2">
                                <label>Descripción *</label>
                                <textarea class="textarea" id="plan-description" rows="3"
                                    placeholder="Describe el objetivo y características del plan..."></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="plan-new-create-sessions">
                        <div class="flex flex-row justify-between items-center space-y-1.5 p-6">
                            <h3 class="flex items-center gap-2">Sesiones de Entrenamiento</h3>
                            <div>
                                <button class="button-small" id="session-add-btn">
                                    <span class="material-symbols-outlined">add</span>Agregar Sesión
                                </button>
                            </div>
                        </div>
                        <div class="p-6 pt-0">
                            <div class="space-y-4">
                                <div id="sessions-container" class="space-y-4"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let sessionCount = 0;
        let excerciseCount = 0;


        const planPreviewName = document.querySelector("#plan-preview-name");
        const planName = document.querySelector('#plan-name');
        planName.addEventListener('input', (e) => { planPreviewName.textContent = e.target.value.trim() || 'Nombre del Plan'; });

        const planPreviewDescription = document.querySelector("#plan-preview-description");
        const planDescription = document.querySelector('#plan-description');
        planDescription.addEventListener('input', (e) => { planPreviewDescription.textContent = e.target.value.trim() || 'Describe el objetivo y características del plan...'; });


        function createSessionCard(id) {
            const card = document.createElement("div");
            card.className = "session-card";
            card.dataset.sessionId = id;

            card.innerHTML = `
                <div class="flex flex-col space-y-1.5 p-6 pb-2">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <div class="session-card-title inline-flex items-center">Sesión ${id}</div>
                            <h3 class="session-card-name">Sesión ${id}</h3>
                        </div>
                        <span class="material-symbols-outlined">keyboard_arrow_right</span>
                    </div>
                </div>

                <div class="p-6 pt-0">
                    <div class="session-card-detail space-y-1"></div>
                </div>
            `;

            document.getElementById("session-cards-container").appendChild(card);
            return card;
        }

        function updateSessionCard(sessionDiv) {
            const id = [...document.querySelectorAll("#sessions-container > div")].indexOf(sessionDiv) + 1;
            const card = document.querySelector(`.session-card[data-session-id="${id}"]`);

            if (!card) return;

            const nameInput = sessionDiv.querySelector(".plan-session-accordion input[type='text']");
            const exercises = sessionDiv.querySelectorAll(".session-excercise");

            // actualizar título de la sesion
            card.querySelector(".session-card-title").textContent = `Sesión ${id}`;
            card.querySelector(".session-card-name").textContent = nameInput.value || "Sesión " + id;

            // actualizar lista de ejercicios
            const detail = card.querySelector(".session-card-detail");
            detail.innerHTML = "";

            exercises.forEach(ex => {
                const title = ex.querySelector("select").value;
                const series = ex.querySelectorAll("input")[0].value;
                const reps = ex.querySelectorAll("input")[1].value;
                const peso = ex.querySelectorAll("input")[2].value;

                detail.innerHTML += `
                    <div class="flex items-center justify-between text-xs py-1">
                        <span class="flex items-center gap-2">
                            <span class="session-card-detail-excercise"></span>${title}
                        </span>
                        <span>${series}×${reps}${peso ? " @ " + peso + "kg" : ""}</span>
                    </div>`;
            });
        }

        // Cerrar todos los accordion menos el que se abre
        function closeAllExcept(id) {
            document.querySelectorAll(".plan-session-accordion").forEach((el, index) => {
                if (index !== id) {
                    el.style.maxHeight = "0";
                }
            });
        }

        function updateAccordionHeight(content) {
            content.style.maxHeight = content.scrollHeight + "px";
        }

        function renumberSessions() {
            const sessions = document.querySelectorAll("#sessions-container > div");
            const cards = document.querySelectorAll("#session-cards-container > .session-card");

            

            sessions.forEach((session, index) => {

                console.log('index: ' + index);
                const num = index + 1;

                // Actualizar badge
                const badge = session.querySelector(".plan-session-header .plan-session-pill");
                badge.textContent = `Sesión ${num}`;

                // Orden
                const orderInput = session.querySelector(".session-order");
                if (orderInput) orderInput.value = num;

                // Actualizar tarjeta
                //const card = cards[index];                
                const card = session.sessionCard;
                card.dataset.sessionId = num;
                card.querySelector(".session-card-title").textContent = `Sesión ${num}`;

                console.log(card);

                updateSessionCard(session);
            });

            sessionCount = sessions.length;
        }

        // Crear sesión
        function createSession() {
            sessionCount++;

            const planSessionPreviewAmount = document.querySelector("#plan-session-preview-amount");
            planSessionPreviewAmount.textContent = `Sesiones (${sessionCount})`;

            const sessionId = sessionCount - 1;
            const container = document.getElementById("sessions-container");

            const div = document.createElement("div");
            div.className = "plan-session";

            div.innerHTML = `

                    <div class="plan-session-header flex items-center justify-between p-2 cursor-pointer">
                        <div class="flex items-center space-x-3">
                            <span class="plan-session-pill">Sesión ${sessionCount}</span>
                            <h2 class="plan-session-name">Sesión ${sessionCount}</h2>
                        </div>
                        <span class="plan-session-number">0 ejercicios ▾</span>
                    </div>

                    <div class="plan-session-accordion">

                        <div class="grid grid-cols-3 gap-4 p-4">
                            <div class="col-span-2"> 
                                <label>Nombre de la sesión *</label>
                                <input type="text" class="input">
                            </div>
                            <div>
                                <label>Orden</label>
                                <input type="number" class="input" value="${sessionCount}">
                            </div>
                        </div>

                        <div class="flex items-center justify-between mb-4">
                            <h4 class="font-medium pl-4">Ejercicios</h4>
                            <div class="pr-4"><button class="button-small add-exercise-btn" type="button"><span class="material-symbols-outlined">add</span>Agregar ejercicio</button></div>
                        </div>

                        <div class="session-excercises space-y-4"></div>

                        <div class="flex flex-row-reverse p-4">
                            <div><button class="delete-session-btn button-small-cancel"><span class="material-symbols-outlined">delete</span>Eliminar Sesión</button></div>
                        </div>
                    </div>
                
            `;

            container.appendChild(div);

            const card = createSessionCard(sessionCount);
            div.sessionCard = card;

            const nameInput = div.querySelector(".plan-session-accordion input[type='text']");
            nameInput.addEventListener("input", () => updateSessionCard(div));


            const planSessionName = document.querySelector('.plan-session-name');
            nameInput.addEventListener('input', (e) => { planSessionName.textContent = e.target.value.trim() || 'Sesión ' + sessionCount; });


            const header = div.querySelector(".plan-session-header");
            const content = div.querySelector(".plan-session-accordion");
            const exerciseContainer = div.querySelector(".session-excercises");
            const counterText = header.querySelector("span:last-child");

            // Toggle abrir/cerrar
            header.addEventListener("click", () => {
                if (content.style.maxHeight && content.style.maxHeight !== "0px") {
                    content.style.maxHeight = "0";
                } else {
                    closeAllExcept(sessionId);
                    updateAccordionHeight(content);
                }
            });

            // Agregar ejercicio
            div.querySelector(".add-exercise-btn").onclick = () => {
                excerciseCount++;
                const card = document.createElement("div");
                card.className = "session-excercise m-4 gap-4";

                card.innerHTML = `                    
                    <div class="grid grid-cols-4 gap-4 items-center">
                        <div>
                            <label>Ejercicio</label>
                            <select class="w-full border rounded-lg p-2 mt-1">
                                <option>Press de banca</option>
                                <option>Press militar</option>
                                <option>Sentadilla</option>
                                <option>Dominadas</option>
                                <option>Remo con barra</option>
                            </select>
                        </div>

                        <div>
                            <label>Series</label>
                            <input class="session-excercise-steps input" type="text" id="session-excercise-steps-${excerciseCount}" value="4">
                        </div>

                        <div>
                            <label>Repeticiones</label>
                            <input class="session-excercise-reps input" type="text" id="session-excercise-reps-${excerciseCount}" value="8">
                        </div>

                        <div>
                            <label>Peso (kg)</label>
                            <div class="flex flex-row items-center gap-4">
                                <input class="session-excercise-weight input" type="text" id="session-excercise-weight-${excerciseCount}" value="0">
                                <div><button class="delete-exercise button-small-cancel p-2"><span class="material-symbols-outlined">delete</span></button></div>
                            </div>
                            
                        </div>
                    </div>                                        
                `;

                exerciseContainer.appendChild(card);
                updateAccordionHeight(content);


                function restrictToDigits(inputSelector, maxDigits = 5) {
                    const input = document.querySelector(inputSelector);
                    if (!input) return;

                    input.addEventListener('input', () => {
                        // Elimina cualquier carácter no numérico
                        let digitsOnly = input.value.replace(/\D/g, '');

                        // Limita la cantidad de dígitos
                        if (digitsOnly.length > maxDigits) {
                            digitsOnly = digitsOnly.slice(0, maxDigits);
                        }

                        // Actualiza el valor del input
                        input.value = digitsOnly;
                    });
                }

                // restringir los inputs numericos
                restrictToDigits('#session-excercise-steps-' + excerciseCount, 2);
                restrictToDigits('#session-excercise-reps-' + excerciseCount, 2);
                restrictToDigits('#session-excercise-weight-' + excerciseCount, 3);


                // actualizar los datos del ejerccio en la vista previa
                const stepsInput = card.querySelector(".session-excercise-steps");
                stepsInput.addEventListener("input", () => updateSessionCard(div));

                const repsInput = card.querySelector(".session-excercise-reps");
                repsInput.addEventListener("input", () => updateSessionCard(div));

                const weightInput = card.querySelector(".session-excercise-weight");
                weightInput.addEventListener("input", () => updateSessionCard(div));

                // actualizar contador
                counterText.textContent = `${exerciseContainer.children.length} ejercicios ▾`;

                // eliminar ejercicio
                card.querySelector(".delete-exercise").onclick = () => {
                    card.remove();
                    counterText.textContent = `${exerciseContainer.children.length} ejercicios ▾`;
                    updateAccordionHeight(content);

                    updateSessionCard(div);
                };

                updateSessionCard(div);
            };

            // Eliminar sesión completa
            div.querySelector(".delete-session-btn").onclick = () => {
                div.remove();
                renumberSessions();   // ← actualizar numeración después de borrar
                div.sessionCard.remove();
                
                const planSessionPreviewAmount = document.querySelector("#plan-session-preview-amount");
                planSessionPreviewAmount.textContent = `Sesiones (${sessionCount})`;
            };
        }

        document.getElementById("session-add-btn").onclick = createSession;

    </script>

    <script>
        /*
        let sessionCount = 0;

        // Cerrar todos los accordion menos el que se abre
        function closeAllExcept(id) {
            document.querySelectorAll(".plan-session-accordion").forEach((el, index) => {
                if (index !== id) {
                    el.style.maxHeight = "0";
                }
            });
        }

        function updateAccordionHeight(content) {
            content.style.maxHeight = content.scrollHeight + "px";
            console.log(content.style.maxHeight);
        }

        function renumberSessions() {
            const sessions = document.querySelectorAll("#sessions-container > div");

            sessions.forEach((session, index) => {
                const num = index + 1;

                // Actualizar badge "Sesión X"
                const badge = session.querySelector(".plan-session-accordion-header span:first-child");
                badge.textContent = `Sesión ${num}`;

                // Actualizar input "Orden"
                const orderInput = session.querySelector(".session-order");
                if (orderInput) orderInput.value = num;
            });

            sessionCount = sessions.length; // actualizar el contador global
        }

        // Crear sesión
        function createSession() {
            sessionCount++;

            const sessionId = sessionCount - 1;
            const container = document.getElementById("sessions-container");

            const div = document.createElement("div");
            div.className = "plan-session";

            div.innerHTML = `

                    <div class="plan-session-header flex items-center justify-between p-2 cursor-pointer plan-session-accordion-header">
                        <div class="flex items-center space-x-3">
                            <span class="plan-session-pill">Sesión ${sessionCount}</span>
                            <h2 class="plan-session-name">Nueva sesión</h2>
                        </div>
                        <span class="plan-session-number">0 ejercicios ▾</span>
                    </div>

                    <div class="plan-session-accordion">

                        <div class="grid grid-cols-3 gap-4 p-4">
                            <div class="col-span-2"> 
                                <label>Nombre de la sesión *</label>
                                <input type="text" class="input">
                            </div>
                            <div>
                                <label>Orden</label>
                                <input type="number" class="input" value="${sessionCount}">
                            </div>
                        </div>

                        <div class="flex items-center justify-between mb-4">
                            <h4 class="font-medium pl-4">Ejercicios</h4>
                            <div class="pr-4"><button class="button-small add-exercise-btn" type="button"><span class="material-symbols-outlined">add</span>Agregar ejercicio</button></div>
                        </div>

                        <div class="session-excercises space-y-4"></div>

                        <div class="flex flex-row-reverse p-4">
                            <div><button class="delete-session-btn button-small-cancel"><span class="material-symbols-outlined">delete</span>Eliminar Sesión</button></div>
                        </div>
                    </div>
                
            `;

            container.appendChild(div);
            
            // ajusta la altura
            adjustContainerHeight();

            const header = div.querySelector(".plan-session-accordion-header");
            const content = div.querySelector(".plan-session-accordion");
            const exerciseContainer = div.querySelector(".session-excercises");
            const counterText = header.querySelector("span:last-child");

            // Toggle abrir/cerrar
            header.addEventListener("click", () => {
                if (content.style.maxHeight && content.style.maxHeight !== "0px") {
                    content.style.maxHeight = "0";
                } else {
                    closeAllExcept(sessionId);
                    //content.style.maxHeight = content.scrollHeight + "px";
                    updateAccordionHeight(content);
                }
            });

            // Agregar ejercicio
            div.querySelector(".add-exercise-btn").onclick = () => {
                const card = document.createElement("div");
                card.className = "session-excercise m-4 gap-4";

                card.innerHTML = `                    
                    <div class="grid grid-cols-4 gap-4 items-center">
                        <div>
                            <label>Ejercicio</label>
                            <select class="w-full border rounded-lg p-2 mt-1">
                                <option>Press de banca</option>
                                <option>Press militar</option>
                                <option>Sentadilla</option>
                                <option>Dominadas</option>
                                <option>Remo con barra</option>
                            </select>
                        </div>

                        <div>
                            <label>Series</label>
                            <input type="number" class="input" value="4">
                        </div>

                        <div>
                            <label>Reps</label>
                            <input type="number" class="input" value="8">
                        </div>

                        <div>
                            <label>Peso (kg)</label>
                            <div class="flex flex-row items-center gap-4">
                                <input type="number" class="input" value="0">
                                <div><button class="delete-exercise button-small-cancel p-2"><span class="material-symbols-outlined">delete</span></button></div>
                            </div>
                            
                        </div>
                    </div>                                        
                `;

                exerciseContainer.appendChild(card);
                updateAccordionHeight(content);

                // actualizar contador
                counterText.textContent = `${exerciseContainer.children.length} ejercicios ▾`;

                // eliminar ejercicio
                card.querySelector(".delete-exercise").onclick = () => {
                    card.remove();
                    counterText.textContent = `${exerciseContainer.children.length} ejercicios ▾`;
                    updateAccordionHeight(content);
                };
            };

            // Eliminar sesión completa
            div.querySelector(".delete-session-btn").onclick = () => {
                div.remove();
                renumberSessions();   // ← actualizar numeración después de borrar
                adjustContainerHeight();
            };

            function adjustContainerHeight() {
                const container = document.querySelector('#sessions-container');
                container.style.height = container.scrollHeight + "px";
            }
        }

        document.getElementById("session-add-btn").onclick = createSession;
        */
    </script>




    <script>
        function openStatisticsModal() {
            //modalPlansDetailRender(plan);
            const overlay = document.getElementById('modal-overlay-statistics');
            const modal = document.getElementById('modal-statistics');

            overlay.style.display = 'flex';
            modal.classList.remove('modal-statistics-exit');
            modal.classList.add('modal-statistics-enter');

        }

        function closeStatisticsModal() {
            const overlay = document.getElementById('modal-overlay-statistics');
            const modal = document.getElementById('modal-statistics');

            modal.classList.remove('modal-statistics-enter');
            modal.classList.add('modal-statistics-exit');
            setTimeout(() => { overlay.style.display = 'none'; }, 250);
        }
    </script>
    <script src="./src/views/login.js" type="module"></script>
    <script src="./src/views/index.js" type="module"></script>
    <script src="./src/views/sidebar.js" type="module"></script>
    <script src="./src/views/mainContent.js" type="module"></script>
</body>

</html>